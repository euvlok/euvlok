name: Update Browser Extensions

on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser type to update (all, chromium, firefox)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
  schedule:
    - cron: "0 */8 * * *"

permissions:
  contents: write

jobs:
  update-extensions:
    name: Update Browser Extensions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Install .NET SDK
        uses: actions/setup-dotnet@v5.1.0
        with:
          dotnet-version: "10.x"

      - name: Run extensions update scripts
        id: update_script
        run: |
          set -euo pipefail

          browser="${{ github.event.inputs.browser }}"
          if [ -z "$browser" ] || [ "$browser" == "all" ]; then
            browsers="chromium firefox"
          else
            browsers="$browser"
          fi

          for browser_type in $browsers; do
            echo "::notice::Processing $browser_type extensions..."

            mapfile -t LIST_FILES < <(find ./modules -name "extensions.toml" -type f)

            for list_file in "${LIST_FILES[@]}"; do
              parent_dir="$(dirname "$(dirname "$list_file")")"
              if [ "$(basename "$parent_dir")" != "$browser_type" ]; then
                continue
              fi

              echo "::group::Processing ${list_file}"
              dotnet run modules/scripts/browser-extensions-update.cs -- -i "$list_file" -b "$browser_type"
              echo "::endgroup::"
            done
          done

          if git diff --quiet; then
            echo "::notice::No changes detected in any extension files."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "::warning::Changes detected in one or more extension files."
            echo "has_changes=true" >> $GITHUB_OUTPUT

            git add hosts/ modules/

            get_extension_details() {
              local nix_file="$1"
              [ -z "$nix_file" ] && return
              nix eval --json --impure --expr "with import <nixpkgs> {}; import \"$nix_file\" { inherit pkgs lib; config = { catppuccin.enable = false; }; }" 2>/dev/null | jq -c '.[]' 2>/dev/null || true
            }

            extract_ext_key() {
              local ext_json="$1"
              local browser_type="$2"
              if [ "$browser_type" = "chromium" ]; then
                echo "$ext_json" | jq -r '"\(.id)|\(.version)|\(.crxPath.url)"' 2>/dev/null
              else
                echo "$ext_json" | jq -r '"\(.name)|\(.version)|\(.url)"' 2>/dev/null
              fi
            }

            get_ext_name() {
              local ext_json="$1"
              local browser_type="$2"
              if [ "$browser_type" = "chromium" ]; then
                echo "$ext_json" | jq -r '.id' 2>/dev/null
              else
                echo "$ext_json" | jq -r '.name' 2>/dev/null
              fi
            }

            get_ext_version() {
              local ext_json="$1"
              echo "$ext_json" | jq -r '.version' 2>/dev/null
            }

            analyze_file_changes() {
              local nix_file="$1" staged_content="$2" head_content="$3"
              local -a added=() removed=() updated=()

              local tmp_staged tmp_head
              tmp_staged=$(mktemp)
              echo "$staged_content" > "$tmp_staged"
              tmp_head=$(mktemp)
              echo "$head_content" > "$tmp_head"

              declare -A old_entries new_entries
              local browser_type="chromium"
              if [[ "$nix_file" == *"firefox"* ]]; then
                browser_type="firefox"
              fi

              if [ -s "$tmp_head" ]; then
                while IFS= read -r ext; do
                  [ -z "$ext" ] && continue
                  local key=$(extract_ext_key "$ext" "$browser_type")
                  local id=$(get_ext_name "$ext" "$browser_type")
                  [ -n "$key" ] && old_entries["$key"]="$ext"
                done <<< "$(get_extension_details "$tmp_head")"
              fi

              if [ -s "$tmp_staged" ]; then
                while IFS= read -r ext; do
                  [ -z "$ext" ] && continue
                  local key=$(extract_ext_key "$ext" "$browser_type")
                  local id=$(get_ext_name "$ext" "$browser_type")
                  [ -n "$key" ] && new_entries["$key"]="$ext"
                done <<< "$(get_extension_details "$tmp_staged")"
              fi

              rm -f "$tmp_staged" "$tmp_head"

              for key in "${!old_entries[@]}"; do
                if [[ ! -v new_entries["$key"] ]]; then
                  local id=$(get_ext_name "${old_entries[$key]}" "$browser_type")
                  removed+=("$id")
                fi
              done

              for key in "${!new_entries[@]}"; do
                local id=$(get_ext_name "${new_entries[$key]}" "$browser_type")
                if [[ ! -v old_entries["$key"] ]]; then
                  added+=("$id")
                elif [ -n "$head_content" ]; then
                  local old_ext="${old_entries[$key]}"
                  local new_ext="${new_entries[$key]}"
                  local old_ver=$(get_ext_version "$old_ext")
                  local new_ver=$(get_ext_version "$new_ext")
                  if [ "$old_ver" != "$new_ver" ]; then
                    updated+=("$id|$old_ver|$new_ver")
                  else
                    local old_hash new_hash
                    if [ "$browser_type" = "chromium" ]; then
                      old_hash=$(echo "$old_ext" | jq -r '.crxPath.hash' 2>/dev/null)
                      new_hash=$(echo "$new_ext" | jq -r '.crxPath.hash' 2>/dev/null)
                    else
                      old_hash=$(echo "$old_ext" | jq -r '.sha256' 2>/dev/null)
                      new_hash=$(echo "$new_ext" | jq -r '.sha256' 2>/dev/null)
                    fi
                    if [ "$old_hash" != "$new_hash" ]; then
                      updated+=("$id|$old_ver|${new_ver} (hash changed)")
                    fi
                  fi
                fi
              done

              local file_label
              file_label=$(basename "$(dirname "$nix_file")")
              file_label="${file_label##*/}"

              [ ${#added[@]} -eq 0 ] && [ ${#removed[@]} -eq 0 ] && [ ${#updated[@]} -eq 0 ] && return

              echo "$file_label ($browser_type):"
              for ext in "${added[@]}"; do
                echo "  + $ext"
              done
              for ext in "${removed[@]}"; do
                echo "  - $ext"
              done
              for item in "${updated[@]}"; do
                IFS='|' read -r ext old_ver new_ver <<< "$item"
                echo "  ~ $ext: $old_ver -> $new_ver"
              done
              echo ""
            }

            CHANGES_DETAIL=""
            while IFS= read -r nix_file; do
              [ -z "$nix_file" ] && continue

              staged_content=$(git show :"$nix_file" 2>/dev/null || true)
              head_content=$(git show HEAD:"$nix_file" 2>/dev/null || true)

              file_changes=$(analyze_file_changes "$nix_file" "$staged_content" "$head_content")
              if [ -n "$file_changes" ]; then
                CHANGES_DETAIL="${CHANGES_DETAIL}${file_changes}"$'\n'
              fi
            done <<< "$(git diff --staged --name-only | grep -E 'extensions\.nix$' | sort || true)"

            {
              echo "changes_summary<<EOF"
              echo ""
              if [ -n "$CHANGES_DETAIL" ]; then
                echo "$CHANGES_DETAIL"
              else
                echo "Updated extension definitions."
              fi
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.update_script.outputs.has_changes == 'true'
        run: |
          set -euo pipefail

          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

          browser="${{ github.event.inputs.browser }}"
          if [ -z "$browser" ] || [ "$browser" == "all" ]; then
            COMMIT_TITLE="chore(browsers): update extensions"
          else
            COMMIT_TITLE="chore($browser): update extensions"
          fi
          
          COMMIT_BODY="${{ steps.update_script.outputs.changes_summary }}"
          git commit -m "$COMMIT_TITLE" -m "$COMMIT_BODY"

          MAX_ATTEMPTS=5
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "::notice::Successfully pushed changes on attempt $i."
              exit 0 # Success
            fi

            if [[ $i -eq $MAX_ATTEMPTS ]]; then
              echo "::error::Failed to push after $MAX_ATTEMPTS attempts."
              exit 1 # All attempts failed
            fi

            wait_time=$((5 * i))
            echo "::warning::Push failed on attempt $i. Waiting ${wait_time}s and retrying after rebase..."
            sleep $wait_time

            git pull --rebase origin ${{ github.ref_name }}
          done
